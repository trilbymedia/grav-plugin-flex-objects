{% extends 'partials/base.html.twig' %}
{% use 'flex-objects/types/default/titlebar/configure.html.twig' %}

{# Get updated object from the form #}
{% set form = form ?? object.form %}
{% set object = form.object %}

{% set route = grav.route.withExtension('') %}

{# Allowed actions #}
{% set can_save = can_save ?? (object.exists ? object.isAuthorized('update') : directory.isAuthorized('create')) %}

{# These variables can be overridden from the main template file #}
{% set allowed = allowed ?? directory is not same as(null) %}
{% set back_route = back_route ?? ('/' ~ route.getRoute(1)) %}
{% set title_icon = title_icon ?? 'fa-cog' %}
{% set title -%}
    {%- set title_config = directory.config('admin.configure.title') -%}
    {%- if title_config.template -%}
        {{- include(template_from_string(title_config.template, 'configure title template')) -}}
    {%- else -%}
        {{- title ?? object.form.getValue('title') ?? 'PLUGIN_ADMIN.CONFIGURATION' -}}
    {% endif %}
{%- endset %}

{% block body %}
    {% set back_url = back_url ?? admin_route(back_route) %}
    {% set blueprint = blueprint ?? directory.configureBlueprint %}

    {{ parent() }}
{% endblock body %}

{% block content_top %}
    {% if allowed and user.authorize('admin.super') %}
        {% if directory and object or action == 'add' %}
            <div class="alert notice">{{ "PLUGIN_ADMIN.SAVE_LOCATION"|tu }}: <b>{{ url('TODO SAVE LOCATION')|trim('/') }}</b></div>
        {% endif %}
    {% endif %}
{% endblock %}

{% block content %}
    {% if allowed and blueprint %}
        <div class="clear directory admin-pages">
            <div class="admin-form-wrapper">
                <div id="admin-topbar">
                    {% block topbar %}{% endblock %}
                </div>
                {% block edit %}
                    {% include 'partials/blueprints.html.twig' with { form: form, data: object, blueprints: blueprint } %}
                {% endblock %}
            </div>
        </div>

        {% include 'partials/modal-changes-detected.html.twig' %}

    {% else %}

        {% do page.modifyHeader('http_response_code', 404) %}
        <div class="error-block">
            <h1>Error 404</h1>
            <div class="padding">
                <p>
                    Woops! Looks like this page doesn't exist.
                </p>
            </div>
        </div>

    {% endif %}
{% endblock %}
